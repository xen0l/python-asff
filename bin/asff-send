#!/usr/bin/env python

import argparse
import os
import sys
import boto3

from asff.constants import DEFAULT_REGION
from asff import AmazonSecurityFinding

DEFAULT_PROFILE = os.environ.get("AWS_PROFILE", "default")


def send_finding_to_securityhub(finding, session):
    client = session.client("securityhub")

    client.batch_import_findings(Findings=[finding])


def parse_aguments():
    parser = argparse.ArgumentParser(
        description="Utility to send ASFF findings to Security Hub easily from command line"
    )

    parser.add_argument("--region", default=DEFAULT_REGION, help="AWS region to use")
    parser.add_argument("--profile", default=DEFAULT_PROFILE, help="AWS profile to use")
    parser.add_argument(
        "file",
        type=argparse.FileType("r"),
        default=sys.stdin,
    )

    return parser.parse_args()


def main():

    args = parse_aguments()

    finding_data = args.file.read()
    finding = AmazonSecurityFinding.from_json(data=finding_data)

    session = boto3.session.Session(profile_name=args.profile, region_name=args.region)

    try:
        send_finding_to_securityhub(finding=finding.to_dict(), session=session)
    except Exception as e:
        print(e.args[0])
        sys.exit(1)


if __name__ == "__main__":
    main()
